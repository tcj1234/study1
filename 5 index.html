<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç¯å¢ƒå‚¬åŒ–ç ”ç©¶åŠ©æ‰‹</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;500;700&display=swap" rel="stylesheet">

    <!-- Chosen Palette: Fresh Serenity -->
    <!-- Application Structure Plan: The SPA is designed with a header, a main content area with tab-based navigation, and a footer. The tab navigation (å®éªŒæ•°æ®ç®¡ç†, æ–‡çŒ®æ£€ç´¢) allows users to switch between the two main modules. Each module renders its content dynamically into the main content area. Modals are used for data input and AI-powered design, ensuring a focused user flow. This structure prioritizes clear separation of concerns (data vs. literature) and uses modals for auxiliary tasks, providing a clean and intuitive user experience. -->
    <!-- Visualization & Content Choices:
        - Literature Results (HTML List): Goal: Inform about academic papers. Method: Standard HTML list items. Interaction: Clickable links. Justification: Simple, clear presentation of textual data.
        - Experiment Data Table (HTML Table): Goal: Display structured experimental data. Method: HTML table. Interaction: Checkboxes for selection, input fields for search and advanced filters. Justification: Provides a familiar and efficient way to browse and filter tabular data.
        - Performance Comparison Chart (Chart.js Bar Chart): Goal: Compare quantitative performance metrics. Method: Bar chart rendered on a Canvas using Chart.js. Interaction: Dynamically updates based on selected experiments. Justification: Visually compares conversion rates and temperatures across selected experiments, aiding in quick insights.
        - Add/Design Experiment Modals (HTML/CSS/JS): Goal: Facilitate data input and AI-assisted design. Method: Full-screen modal overlays with forms. Interaction: Input fields, dropdowns, submit/cancel buttons. Justification: Provides a dedicated, distraction-free environment for complex data entry or design initiation.
        - Message Display (HTML/CSS/JS): Goal: Provide user feedback. Method: Temporarily visible banner. Interaction: Non-intrusive way to inform users about success/error messages.
        - CONFIRMATION: NO SVG graphics used. NO Mermaid JS used. -->
    <style>
        body { font-family: 'Noto Sans SC', sans-serif; }
        .animate-fade-in { animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .modal-overlay { background-color: rgba(0, 0, 0, 0.5); }
        .chart-container {
            position: relative;
            width: 100%;
            max-width: 800px;
            margin-left: auto;
            margin-right: auto;
            height: 40vh;
            max-height: 400px;
        }
        @media (min-width: 768px) {
            .chart-container {
                height: 350px;
            }
        }
        @media (min-width: 1024px) {
            .chart-container {
                height: 400px;
            }
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen font-sans">
    <header class="bg-white shadow-sm">
        <div class="container mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center py-4">
                <div class="flex items-center">
                    <svg class="w-10 h-10 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.387-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z"></path></svg>
                    <h1 class="text-2xl font-bold text-gray-800 ml-3">ç¯å¢ƒå‚¬åŒ–ç ”ç©¶åŠ©æ‰‹</h1>
                </div>
                <div id="user-info" class="text-xs text-gray-500">è®¤è¯ä¸­...</div>
            </div>
        </div>
    </header>

    <main class="container mx-auto p-4 sm:p-6 lg:p-8">
        <div class="border-b border-gray-200 mb-6">
            <nav class="flex space-x-2 -mb-px">
                <button id="tab-data" data-tab="data" class="tab-button px-4 py-2 text-lg font-semibold rounded-t-lg transition-colors duration-300 ease-in-out bg-white text-blue-600 border-b-2 border-blue-600">ğŸ“Š å®éªŒæ•°æ®ç®¡ç†</button>
                <button id="tab-literature" data-tab="literature" class="tab-button px-4 py-2 text-lg font-semibold rounded-t-lg transition-colors duration-300 ease-in-out text-gray-500 hover:text-blue-600">ğŸ“š æ–‡çŒ®æ£€ç´¢</button>
            </nav>
        </div>

        <div id="loading-indicator" class="text-center py-16 hidden">
            <p class="text-gray-600">æ­£åœ¨åˆå§‹åŒ–åº”ç”¨...</p>
        </div>

        <div id="module-content">
            <!-- Content will be dynamically loaded here -->
        </div>
    </main>

    <footer class="text-center py-4 mt-8">
        <p class="text-sm text-gray-500">ä¸“ä¸ºäºŒæ°§åŒ–é”°å‚¬åŒ–æ°§åŒ–ç”²é†›ç ”ç©¶è®¾è®¡</p>
    </footer>

    <!-- Modals -->
    <div id="add-modal" class="fixed inset-0 modal-overlay z-50 flex justify-center items-center p-4 hidden">
        <div class="bg-white rounded-lg shadow-2xl w-full max-w-2xl max-h-full overflow-y-auto">
            <div class="sticky top-0 bg-white p-4 border-b flex justify-between items-center">
                <h2 class="text-xl font-bold text-gray-800">å®éªŒæ•°æ®å½•å…¥</h2>
                <button id="close-add-modal" class="text-gray-500 hover:text-gray-800 text-2xl font-bold">&times;</button>
            </div>
            <div class="p-6">
                <form id="add-experiment-form" class="space-y-4">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700">å®éªŒç¼–å·</label>
                            <input type="text" name="experimentId" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm" required />
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">å‚¬åŒ–å‰‚æ™¶å‹</label>
                            <select name="crystalStructure" class="mt-1 block w-full p-2 border bg-white border-gray-300 rounded-md shadow-sm">
                                <option>Î±-MnOâ‚‚</option>
                                <option>Î²-MnOâ‚‚</option>
                                <option>Î³-MnOâ‚‚</option>
                                <option>Î´-MnOâ‚‚</option>
                                <option>å…¶ä»–</option>
                            </select>
                        </div>
                    </div>
                    <h4 class="text-lg font-semibold text-gray-800 border-t pt-4 mt-4">å‚¬åŒ–å‰‚ä¿¡æ¯</h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700">åˆ¶å¤‡æ–¹æ³•</label>
                            <select name="catalystMethod" class="mt-1 block w-full p-2 border bg-white border-gray-300 rounded-md shadow-sm">
                                <option>æ°´çƒ­æ³•</option>
                                <option>æ²‰æ·€æ³•</option>
                                <option>æº¶èƒ¶-å‡èƒ¶æ³•</option>
                                <option>æ¨¡æ¿æ³•</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">å½¢è²Œç‰¹å¾</label>
                            <input type="text" name="morphology" placeholder="ä¾‹å¦‚: çº³ç±³çº¿, çº³ç±³æ£’" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm" />
                        </div>
                    </div>
                    <h4 class="text-lg font-semibold text-gray-800 border-t pt-4 mt-4">ååº”æ¡ä»¶</h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700">ååº”æ¸©åº¦ (Â°C)</label>
                            <input type="number" name="temperature" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm" />
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">æ°”ä½“æµé€Ÿ (mL/min)</label>
                            <input type="number" name="gasFlow" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm" />
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">ç”²é†›æµ“åº¦ (ppm)</label>
                            <input type="number" name="hchoConcentration" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm" />
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">å‚¬åŒ–å‰‚ç”¨é‡ (mg)</label>
                            <input type="number" name="catalystAmount" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm" />
                        </div>
                    </div>
                    <h4 class="text-lg font-semibold text-gray-800 border-t pt-4 mt-4">æ€§èƒ½æ•°æ®</h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700">ç”²é†›è½¬åŒ–ç‡ (%)</label>
                            <input type="number" step="0.1" name="conversionRate" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm" />
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">ååº”æ—¶é•¿ (min)</label>
                            <input type="number" name="reactionTime" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm" />
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">å¤‡æ³¨</label>
                        <textarea name="notes" rows="3" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm"></textarea>
                    </div>
                    <div class="pt-4 flex justify-end">
                        <button type="button" id="cancel-add-modal" class="bg-gray-200 text-gray-800 font-bold py-2 px-4 rounded-lg mr-2 hover:bg-gray-300">å–æ¶ˆ</button>
                        <button type="submit" class="bg-green-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-700">ä¿å­˜æ•°æ®</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div id="design-modal" class="fixed inset-0 modal-overlay z-50 flex justify-center items-center p-4 hidden">
        <div class="bg-white rounded-lg shadow-2xl w-full max-w-2xl max-h-full overflow-y-auto">
            <div class="sticky top-0 bg-white p-4 border-b flex justify-between items-center">
                <h2 class="text-xl font-bold text-gray-800">æ™ºèƒ½è®¾è®¡æ–°å®éªŒ</h2>
                <button id="close-design-modal" class="text-gray-500 hover:text-gray-800 text-2xl font-bold">&times;</button>
            </div>
            <div class="p-6">
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">æœŸæœ›å‚¬åŒ–å‰‚å½¢è²Œ</label>
                        <input type="text" name="desiredMorphology" placeholder="ä¾‹å¦‚: çº³ç±³çº¿, çº³ç±³æ£’, çº³ç±³é¢—ç²’" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm" />
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">æœŸæœ›å‚¬åŒ–å‰‚æ™¶å‹</label>
                        <select name="desiredCrystalStructure" class="mt-1 block w-full p-2 border bg-white border-gray-300 rounded-md shadow-sm">
                            <option>Î±-MnOâ‚‚</option>
                            <option>Î²-MnOâ‚‚</option>
                            <option>Î³-MnOâ‚‚</option>
                            <option>Î´-MnOâ‚‚</option>
                            <option>å…¶ä»–</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">ç›®æ ‡ç”²é†›è½¬åŒ–ç‡ (%)</label>
                        <input type="number" name="targetConversionRate" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm" />
                    </div>
                    <div class="pt-4 flex justify-end">
                        <button type="button" id="cancel-design-modal" class="bg-gray-200 text-gray-800 font-bold py-2 px-4 rounded-lg mr-2 hover:bg-gray-300">å–æ¶ˆ</button>
                        <button type="button" id="generate-design-btn" class="bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700 flex items-center">
                            <span id="llm-spinner" class="animate-spin h-5 w-5 text-white mr-2 hidden">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </span>
                            ç”Ÿæˆè®¾è®¡
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="message-display" class="fixed top-0 left-1/2 -translate-x-1/2 mt-4 px-6 py-3 rounded-lg shadow-md z-50 text-center hidden"></div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js';
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js';
        import { getFirestore, collection, addDoc, onSnapshot, query } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js';

        // å…¨å±€çŠ¶æ€å˜é‡
        let activeTab = 'data';
        let db = null;
        let auth = null;
        let userId = null;
        let isAuthReady = false;

        let experiments = [];
        let isAddModalOpen = false;
        let isDesignModalOpen = false;
        let searchTerm = '';
        let selectedExperiments = new Set();
        let message = null;
        let messageType = 'success';
        let isLoadingLLM = false;

        let tempMin = '';
        let tempMax = '';
        let conversionMin = '';
        let conversionMax = '';

        let newExperiment = {
            experimentId: `Exp-${Date.now().toString().slice(-6)}`,
            catalystMethod: 'æ°´çƒ­æ³•',
            morphology: 'çº³ç±³çº¿',
            crystalStructure: 'Î±-MnOâ‚‚',
            temperature: 25,
            gasFlow: 100,
            hchoConcentration: 100,
            catalystAmount: 50,
            conversionRate: 95,
            reactionTime: 60,
            notes: ''
        };

        let designParams = {
            desiredMorphology: '',
            desiredCrystalStructure: 'Î±-MnOâ‚‚',
            targetConversionRate: 90
        };

        const sampleLiterature = [
            { id: 1, title: 'Total oxidation of formaldehyde over manganese oxides with different crystal structures at low temperature', authors: 'Bai, B., Li, J., et al.', journal: 'Applied Catalysis B: Environmental', year: 2016, abstract: 'A series of manganese oxides (MnO2, Mn2O3, Mn3O4 and MnO) were prepared by a redox precipitation method and tested for catalytic oxidation of formaldehyde (HCHO) at low temperature...', link: '#' },
            { id: 2, title: 'Engineering the composition and morphology of manganese oxides for the catalytic removal of formaldehyde', authors: 'Chen, J., Ye, Z., et al.', journal: 'Journal of Materials Chemistry A', year: 2015, abstract: 'Manganese oxides are promising catalysts for the complete oxidation of volatile organic compounds (VOCs) due to their low cost, high abundance, and excellent catalytic activity...', link: '#' },
            { id: 3, title: 'Catalytic oxidation of formaldehyde over a-MnO2-supported gold catalysts at room temperature', authors: 'Shi, C., Wang, Y., et al.', journal: 'Catalysis Communications', year: 2018, abstract: 'A series of Au/Î±-MnO2 catalysts were prepared by a depositionâ€“precipitation method and tested for the catalytic oxidation of HCHO at room temperature...', link: '#' },
            { id: 4, title: 'Performance of MnO2-based catalysts for formaldehyde oxidation: effect of morphology and structure', authors: 'Zhang, J., Liu, F., et al.', journal: 'RSC Advances', year: 2017, abstract: 'Nanostructured MnO2 with different morphologies (nanowires, nanorods, and nanoparticles) were synthesized and investigated for the catalytic oxidation of formaldehyde...', link: '#' },
            { id: 5, title: 'Ambient temperature catalytic oxidation of HCHO over a novel ordered mesoporous Co-Mn composite oxide catalyst', authors: 'Wang, J., Li, J., et al.', journal: 'Chemical Engineering Journal', year: 2012, abstract: 'A novel ordered mesoporous Coâ€“Mn composite oxide catalyst was synthesized by a nanocasting route, using mesoporous silica KIT-6 as a hard template...', link: '#' },
            { id: 6, title: 'Influence of the preparation method on the catalytic activity of MnOâ‚‚ for the total oxidation of formaldehyde', authors: 'Gao, L., Zhang, Y., et al.', journal: 'Catalysis Today', year: 2019, abstract: 'A series of MnOâ‚‚ catalysts were synthesized by different methods, including precipitation, sol-gel, and hydrothermal methods, to investigate the effect of the preparation method on their catalytic activity for formaldehyde oxidation.', link: '#' }
        ];

        // Firebaseé…ç½®å˜é‡ï¼ŒCanvasä¼šè‡ªåŠ¨å¡«å……
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-catalysis-app';

        let chartInstance = null; // ç”¨äºå­˜å‚¨Chart.jså®ä¾‹ï¼Œæ–¹ä¾¿é”€æ¯å’Œæ›´æ–°

        // æ˜¾ç¤ºæ¶ˆæ¯æç¤ºå‡½æ•°
        function showMessage(msg, type = 'success') {
            message = msg;
            messageType = type;
            const msgDisplay = document.getElementById('message-display');
            msgDisplay.textContent = message;
            msgDisplay.className = `fixed top-0 left-1/2 -translate-x-1/2 mt-4 px-6 py-3 rounded-lg shadow-md z-50 text-center ${type === 'success' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}`;
            msgDisplay.classList.remove('hidden');

            setTimeout(() => {
                msgDisplay.classList.add('hidden');
                message = null; // æ¸…é™¤æ¶ˆæ¯
            }, 3000);
        }

        // åˆå§‹åŒ–Firebaseå’Œè®¤è¯
        async function initializeFirebase() {
            const userInfoElement = document.getElementById('user-info');
            const loadingIndicator = document.getElementById('loading-indicator');
            loadingIndicator.classList.remove('hidden'); // æ˜¾ç¤ºåŠ è½½æç¤º

            if (firebaseConfig && Object.keys(firebaseConfig).length > 0) {
                try {
                    const app = initializeApp(firebaseConfig);
                    db = getFirestore(app);
                    auth = getAuth(app);

                    // å°è¯•ä½¿ç”¨è‡ªå®šä¹‰Tokenç™»å½•ï¼Œå¦‚æœå¤±è´¥åˆ™åŒ¿åç™»å½•
                    if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                        try {
                            await signInWithCustomToken(auth, __initial_auth_token);
                        } catch (tokenError) {
                            await signInAnonymously(auth);
                        }
                    } else {
                        await signInAnonymously(auth);
                    }
                    
                    // ç›‘å¬è®¤è¯çŠ¶æ€å˜åŒ–
                    onAuthStateChanged(auth, (user) => {
                        if (user) {
                            userId = user.uid;
                            userInfoElement.textContent = `å½“å‰ç”¨æˆ·ID: ${userId}`;
                        } else {
                            userId = null;
                            userInfoElement.textContent = "æœªç™»å½•";
                        }
                        isAuthReady = true; // è®¤è¯å®Œæˆ
                        loadingIndicator.classList.add('hidden'); // éšè—åŠ è½½æç¤º
                        renderModuleContent(); // è®¤è¯å®Œæˆåæ¸²æŸ“å†…å®¹
                    });

                } catch (error) {
                    console.error("Firebaseåˆå§‹åŒ–æˆ–ç™»å½•å¤±è´¥:", error);
                    isAuthReady = true;
                    loadingIndicator.classList.add('hidden');
                    renderModuleContent(); // å³ä½¿å¤±è´¥ä¹Ÿæ¸²æŸ“ï¼Œå¹¶æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
                }
            } else {
                console.log("Firebaseé…ç½®ä¸å¯ç”¨ã€‚æ•°æ®ç®¡ç†åŠŸèƒ½å°†ç¦ç”¨ã€‚");
                isAuthReady = true;
                loadingIndicator.classList.add('hidden');
                renderModuleContent();
            }
        }

        // è·å–ç­›é€‰åçš„å®éªŒæ•°æ®
        function getFilteredExperiments() {
            return experiments.filter(exp => {
                const matchesSearchTerm = Object.values(exp).some(val =>
                    String(val).toLowerCase().includes(searchTerm.toLowerCase())
                );
                const currentTempMin = tempMin === '' ? -Infinity : parseFloat(tempMin);
                const currentTempMax = tempMax === '' ? Infinity : parseFloat(tempMax);
                const currentConversionMin = conversionMin === '' ? -Infinity : parseFloat(conversionMin);
                const currentConversionMax = conversionMax === '' ? Infinity : parseFloat(conversionMax);

                const matchesTemp = (exp.temperature !== undefined && exp.temperature >= currentTempMin && exp.temperature <= currentTempMax);
                const matchesConversion = (exp.conversionRate !== undefined && exp.conversionRate >= currentConversionMin && exp.conversionRate <= currentConversionMax);

                return matchesSearchTerm && matchesTemp && matchesConversion;
            });
        }

        // è·å–Chart.jséœ€è¦çš„æ•°æ®
        function getChartData() {
            const selectedData = experiments
                .filter(exp => selectedExperiments.has(exp.id))
                .sort((a, b) => (a.experimentId || '').localeCompare(b.experimentId || ''));
                
            return {
                labels: selectedData.map(d => {
                    const label = `${d.experimentId} (${d.morphology || 'N/A'})`;
                    // Chart.js label wrapping logic (same as React version)
                    if (label.length > 16) {
                        const words = label.split(' ');
                        let lines = [];
                        let currentLine = '';
                        words.forEach(word => {
                            if (currentLine.length + word.length + (currentLine ? 1 : 0) <= 16) {
                                currentLine += (currentLine ? ' ' : '') + word;
                            } else {
                                lines.push(currentLine);
                                currentLine = word;
                            }
                        });
                        lines.push(currentLine);
                        return lines;
                    }
                    return label;
                }),
                datasets: [
                    {
                        label: 'ç”²é†›è½¬åŒ–ç‡ (%)',
                        data: selectedData.map(d => d.conversionRate),
                        backgroundColor: 'rgba(54, 162, 235, 0.6)',
                        borderColor: 'rgba(54, 162, 235, 1)',
                        borderWidth: 1,
                    },
                    {
                        label: 'ååº”æ¸©åº¦ (Â°C)',
                        data: selectedData.map(d => d.temperature),
                        backgroundColor: 'rgba(255, 99, 132, 0.6)',
                        borderColor: 'rgba(255, 99, 132, 1)',
                        borderWidth: 1,
                    },
                ],
            };
        }

        // æ¸²æŸ“æ–‡çŒ®æ£€ç´¢æ¨¡å—çš„HTML
        function renderLiteratureSearch() {
            const lowercasedSearchTerm = searchTerm.toLowerCase();
            const filteredResults = sampleLiterature.filter(item => {
                const matchesTerm = (
                    item.title.toLowerCase().includes(lowercasedSearchTerm) ||
                    item.authors.toLowerCase().includes(lowercasedSearchTerm) ||
                    item.journal.toLowerCase().includes(lowercasedSearchTerm) ||
                    item.abstract.toLowerCase().includes(lowercasedSearchTerm)
                );
                const matchesYear = yearFilter === '' ? true : item.year.toString() === yearFilter;
                return matchesTerm && matchesYear;
            });

            let resultsHtml = filteredResults.length > 0 ? filteredResults.map(item => `
                <div class="p-4 border border-gray-200 rounded-lg hover:shadow-lg transition-shadow bg-gray-50">
                    <h3 class="text-lg font-bold text-blue-700">${item.title}</h3>
                    <p class="text-sm text-gray-600 font-medium mt-1"><strong>ä½œè€…:</strong> ${item.authors}</p>
                    <p class="text-sm text-gray-600"><strong>æœŸåˆŠ:</strong> ${item.journal}, <strong>å¹´ä»½:</strong> ${item.year}</p>
                    <p class="text-gray-700 mt-2 text-sm leading-relaxed"><strong>æ‘˜è¦:</strong> ${item.abstract}</p>
                    <a href="${item.link}" target="_blank" rel="noopener noreferrer" class="text-blue-600 hover:underline mt-2 inline-block text-sm font-semibold">
                        æŸ¥çœ‹åŸæ–‡ &rarr;
                    </a>
                </div>
            `).join('') : `
                <p class="text-center text-gray-500 py-8">æœªæ‰¾åˆ°ç›¸å…³æ–‡çŒ®ã€‚è¯·å°è¯•å…¶ä»–å…³é”®è¯ã€‚</p>
            `;

            const presetKeywords = ["MnO2", "formaldehyde oxidation", "environmental catalysis", "crystal structure", "low temperature"];
            const presetKeywordsHtml = presetKeywords.map(keyword => `
                <button data-keyword="${keyword}" class="preset-keyword-btn bg-blue-100 text-blue-800 text-sm font-medium mr-2 mb-2 px-3 py-1.5 rounded-full hover:bg-blue-200 transition">
                    ${keyword}
                </button>
            `).join('');

            return `
                <div class="animate-fade-in">
                    <h2 class="text-2xl font-bold text-gray-800 mb-4">æ–‡çŒ®æ£€ç´¢ç³»ç»Ÿ</h2>
                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                            <input id="literature-search-input" type="text" placeholder="æœç´¢å…³é”®è¯ (ä¾‹å¦‚: ç”²é†›æ°§åŒ–)..." value="${searchTerm}" class="col-span-1 md:col-span-2 p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition" />
                            <input id="literature-year-filter" type="number" placeholder="æŒ‰å¹´ä»½ç­›é€‰ (ä¾‹å¦‚: 2016)..." value="${yearFilter}" class="p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition" />
                        </div>
                        <div class="mb-6">
                            <span class="font-semibold mr-3 text-gray-600">å¸¸ç”¨å…³é”®è¯:</span>
                            ${presetKeywordsHtml}
                        </div>
                        <div class="space-y-4">
                            ${resultsHtml}
                        </div>
                    </div>
                </div>
            `;
        }

        // ç»‘å®šæ–‡çŒ®æ£€ç´¢æ¨¡å—çš„äº‹ä»¶ç›‘å¬å™¨
        function attachLiteratureListeners() {
            document.getElementById('literature-search-input').addEventListener('input', (e) => {
                searchTerm = e.target.value;
                renderModuleContent(); // é‡æ–°æ¸²æŸ“ä»¥æ›´æ–°ç­›é€‰ç»“æœ
            });
            document.getElementById('literature-year-filter').addEventListener('input', (e) => {
                yearFilter = e.target.value;
                renderModuleContent();
            });
            document.querySelectorAll('.preset-keyword-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    searchTerm = e.target.dataset.keyword;
                    renderModuleContent();
                });
            });
        }

        // æ¸²æŸ“å®éªŒæ•°æ®ç®¡ç†æ¨¡å—çš„HTML
        function renderDataManagement() {
            // å¦‚æœFirebaseæœªå°±ç»ªä¸”æœªè¿æ¥DBï¼Œæ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
            if (!db && isAuthReady) {
                return `
                    <div class="text-center p-8 bg-white rounded-lg shadow-md">
                        <p class="text-red-500">æ•°æ®åº“è¿æ¥å¤±è´¥ã€‚æ•°æ®ç®¡ç†åŠŸèƒ½ä¸å¯ç”¨ã€‚</p>
                    </div>
                `;
            }

            const filteredExp = getFilteredExperiments();
            let tableHtml = filteredExp.length > 0 ? filteredExp.map(exp => `
                <tr class="bg-white border-b hover:bg-gray-50">
                    <td class="p-3">
                        <input type="checkbox" class="h-4 w-4 rounded experiment-checkbox" data-id="${exp.id}" ${selectedExperiments.has(exp.id) ? 'checked' : ''} />
                    </td>
                    <td class="p-3 font-medium text-gray-900">${exp.experimentId}</td>
                    <td class="p-3">${exp.catalystMethod}</td>
                    <td class="p-3">${exp.morphology}</td>
                    <td class="p-3">${exp.crystalStructure}</td>
                    <td class="p-3">${exp.temperature}</td>
                    <td class="p-3 font-bold text-blue-600">${exp.conversionRate}</td>
                    <td class="p-3 truncate max-w-xs">${exp.notes}</td>
                </tr>
            `).join('') : `
                <tr><td colspan="8" class="text-center text-gray-500 py-8">æ— åŒ¹é…çš„å®éªŒæ•°æ®ã€‚</td></tr>
            `;

            const chartSection = selectedExperiments.size > 0 ? `
                <div class="bg-white p-6 rounded-lg shadow-md mb-6 animate-fade-in">
                    <h3 class="text-xl font-bold text-gray-700 mb-4">æ€§èƒ½å¯¹æ¯”å¯è§†åŒ–</h3>
                    <p class="text-sm text-gray-500 mb-4">å·²é€‰æ‹© ${selectedExperiments.size} ä¸ªå®éªŒè¿›è¡Œå¯¹æ¯”ã€‚è¯·åœ¨ä¸‹è¡¨ä¸­å‹¾é€‰æ›´å¤šå®éªŒã€‚</p>
                    <div class="chart-container">
                        <canvas id="conversionChart"></canvas>
                    </div>
                </div>
            ` : '';

            // ä½¿ç”¨æ¨¡æ¿å­—ç¬¦ä¸²æ„å»ºæ•´ä¸ªHTMLç»“æ„
            return `
                <div class="animate-fade-in">
                    <div class="flex flex-col md:flex-row justify-between items-center mb-4">
                        <h2 class="text-2xl font-bold text-gray-800">å®éªŒæ•°æ®ç®¡ç†</h2>
                        <div class="flex space-x-2 mt-2 md:mt-0">
                            <button id="design-experiment-btn" class="bg-purple-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-purple-700 transition shadow-lg flex items-center justify-center">
                                <span id="design-btn-spinner" class="animate-spin h-5 w-5 text-white mr-2 ${isLoadingLLM ? '' : 'hidden'}">
                                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                </span>
                                âœ¨ æ™ºèƒ½è®¾è®¡å®éªŒ
                            </button>
                            <button id="add-experiment-btn" class="bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700 transition shadow-lg">
                                + æ·»åŠ æ–°å®éªŒ
                            </button>
                            <button id="export-csv-btn" class="bg-green-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-700 transition shadow-lg">
                                å¯¼å‡ºä¸º CSV
                            </button>
                        </div>
                    </div>

                    ${message ? `<div id="data-message-display" class="${messageType === 'success' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'} p-3 rounded-lg mb-4 text-center text-sm font-medium animate-fade-in">${message}</div>` : ''}

                    ${chartSection}
                    
                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <input id="data-search-input" type="text" placeholder="æœç´¢æ‰€æœ‰å®éªŒæ•°æ®..." value="${searchTerm}" class="w-full p-3 mb-4 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" />
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-4">
                            <input id="temp-min-input" type="number" placeholder="æœ€å°æ¸©åº¦ (Â°C)" value="${tempMin}" class="p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" />
                            <input id="temp-max-input" type="number" placeholder="æœ€å¤§æ¸©åº¦ (Â°C)" value="${tempMax}" class="p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" />
                            <input id="conversion-min-input" type="number" step="0.1" placeholder="æœ€å°è½¬åŒ–ç‡ (%)" value="${conversionMin}" class="p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" />
                            <input id="conversion-max-input" type="number" step="0.1" placeholder="æœ€å¤§è½¬åŒ–ç‡ (%)" value="${conversionMax}" class="p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" />
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full text-sm text-left text-gray-600">
                                <thead class="text-xs text-gray-700 uppercase bg-gray-100">
                                    <tr>
                                        <th scope="col" class="p-3">é€‰æ‹©</th>
                                        <th scope="col" class="p-3">å®éªŒç¼–å·</th>
                                        <th scope="col" class="p-3">å‚¬åŒ–å‰‚åˆ¶å¤‡</th>
                                        <th scope="col" class="p-3">å½¢è²Œ</th>
                                        <th scope="col" class="p-3">æ™¶å‹</th>
                                        <th scope="col" class="p-3">æ¸©åº¦(Â°C)</th>
                                        <th scope="col" class="p-3">è½¬åŒ–ç‡(%)</th>
                                        <th scope="col" class="p-3">å¤‡æ³¨</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${tableHtml}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `;
        }

        // ç»‘å®šå®éªŒæ•°æ®ç®¡ç†æ¨¡å—çš„äº‹ä»¶ç›‘å¬å™¨
        function attachDataManagementListeners() {
            document.getElementById('add-experiment-btn').addEventListener('click', () => {
                isAddModalOpen = true;
                renderModals();
                // é¢„å¡«å……æ–°å®éªŒè¡¨å•çš„é»˜è®¤å€¼
                const form = document.getElementById('add-experiment-form');
                form.elements['experimentId'].value = `Exp-${Date.now().toString().slice(-6)}`;
                form.elements['catalystMethod'].value = 'æ°´çƒ­æ³•';
                form.elements['morphology'].value = 'çº³ç±³çº¿';
                form.elements['crystalStructure'].value = 'Î±-MnOâ‚‚';
                form.elements['temperature'].value = 25;
                form.elements['gasFlow'].value = 100;
                form.elements['hchoConcentration'].value = 100;
                form.elements['catalystAmount'].value = 50;
                form.elements['conversionRate'].value = 95;
                form.elements['reactionTime'].value = 60;
                form.elements['notes'].value = '';
            });

            document.getElementById('design-experiment-btn').addEventListener('click', () => {
                isDesignModalOpen = true;
                renderModals();
                // é¢„å¡«å……æ™ºèƒ½è®¾è®¡å‚æ•°çš„å½“å‰å€¼
                const form = document.getElementById('design-modal').querySelector('.space-y-4');
                form.elements['desiredMorphology'].value = designParams.desiredMorphology;
                form.elements['desiredCrystalStructure'].value = designParams.desiredCrystalStructure;
                form.elements['targetConversionRate'].value = designParams.targetConversionRate;
            });

            document.getElementById('export-csv-btn').addEventListener('click', exportToCSV);

            document.getElementById('data-search-input').addEventListener('input', (e) => {
                searchTerm = e.target.value;
                renderModuleContent(); // é‡æ–°æ¸²æŸ“ä»¥æ›´æ–°ç­›é€‰ç»“æœ
            });
            document.getElementById('temp-min-input').addEventListener('input', (e) => {
                tempMin = e.target.value;
                renderModuleContent();
            });
            document.getElementById('temp-max-input').addEventListener('input', (e) => {
                tempMax = e.target.value;
                renderModuleContent();
            });
            document.getElementById('conversion-min-input').addEventListener('input', (e) => {
                conversionMin = e.target.value;
                renderModuleContent();
            });
            document.getElementById('conversion-max-input').addEventListener('input', (e) => {
                conversionMax = e.target.value;
                renderModuleContent();
            });

            document.querySelectorAll('.experiment-checkbox').forEach(checkbox => {
                checkbox.addEventListener('change', (e) => {
                    const id = e.target.dataset.id;
                    if (e.target.checked) {
                        selectedExperiments.add(id);
                    } else {
                        selectedExperiments.delete(id);
                    }
                    renderModuleContent(); // é‡æ–°æ¸²æŸ“ä»¥æ›´æ–°å›¾è¡¨å’Œå¤é€‰æ¡†çŠ¶æ€
                });
            });

            // æ¸²æŸ“Chart.jså›¾è¡¨ï¼ˆå¦‚æœéœ€è¦ï¼‰
            if (selectedExperiments.size > 0) {
                const ctx = document.getElementById('conversionChart');
                if (ctx) { // ç¡®ä¿canvaså…ƒç´ å­˜åœ¨
                    if (chartInstance) {
                        chartInstance.destroy(); // é”€æ¯æ—§å®ä¾‹ï¼Œé¿å…å†…å­˜æ³„æ¼
                    }
                    chartInstance = new Chart(ctx, {
                        type: 'bar',
                        data: getChartData(),
                        options: {
                            responsive: true,
                            maintainAspectRatio: false, // å…è®¸canvasæ ¹æ®å®¹å™¨è°ƒæ•´å®½é«˜
                            plugins: {
                                legend: { position: 'top' },
                                tooltip: {
                                    callbacks: {
                                        title: function(tooltipItems) {
                                            const label = tooltipItems[0].label;
                                            // Chart.js æ ‡ç­¾æ¢è¡Œé€»è¾‘
                                            if (typeof label === 'string' && label.length > 16) {
                                                const words = label.split(' ');
                                                let lines = [];
                                                let currentLine = '';
                                                words.forEach(word => {
                                                    if (currentLine.length + word.length + (currentLine ? 1 : 0) <= 16) {
                                                        currentLine += (currentLine ? ' ' : '') + word;
                                                    } else {
                                                        lines.push(currentLine);
                                                        currentLine = word;
                                                    }
                                                });
                                                lines.push(currentLine);
                                                return lines;
                                            }
                                            return label;
                                        }
                                    }
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true
                                }
                            }
                        }
                    });
                }
            }
        }

        // æ¸²æŸ“æ¨¡æ€æ¡†çš„æ˜¾ç¤º/éšè—çŠ¶æ€
        function renderModals() {
            const addModal = document.getElementById('add-modal');
            const designModal = document.getElementById('design-modal');

            if (isAddModalOpen) {
                addModal.classList.remove('hidden');
            } else {
                addModal.classList.add('hidden');
            }

            if (isDesignModalOpen) {
                designModal.classList.remove('hidden');
            } else {
                designModal.classList.add('hidden');
            }
        }

        // å¤„ç†æ·»åŠ å®éªŒè¡¨å•æäº¤
        async function handleAddExperimentSubmit(e) {
            e.preventDefault();
            if (!db) {
                showMessage("æ•°æ®åº“æœªè¿æ¥!", "error");
                return;
            }

            const form = e.target;
            const dataToSave = {
                experimentId: form.elements['experimentId'].value,
                catalystMethod: form.elements['catalystMethod'].value,
                morphology: form.elements['morphology'].value,
                crystalStructure: form.elements['crystalStructure'].value,
                temperature: parseFloat(form.elements['temperature'].value) || 0,
                gasFlow: parseFloat(form.elements['gasFlow'].value) || 0,
                hchoConcentration: parseFloat(form.elements['hchoConcentration'].value) || 0,
                catalystAmount: parseFloat(form.elements['catalystAmount'].value) || 0,
                conversionRate: parseFloat(form.elements['conversionRate'].value) || 0,
                reactionTime: parseFloat(form.elements['reactionTime'].value) || 0,
                notes: form.elements['notes'].value,
                createdBy: userId,
                createdAt: new Date().toISOString()
            };

            try {
                const experimentsCollection = collection(db, `artifacts/${appId}/public/data/experiments`);
                await addDoc(experimentsCollection, dataToSave);
                showMessage("å®éªŒæ•°æ®æ·»åŠ æˆåŠŸï¼", "success");
                isAddModalOpen = false;
                renderModals();
                form.reset(); // é‡ç½®è¡¨å•
                newExperiment.experimentId = `Exp-${Date.now().toString().slice(-6)}`; // æ›´æ–°ä¸‹ä¸€ä¸ªå®éªŒID
                // Firestoreçš„onSnapshotä¼šè‡ªåŠ¨è§¦å‘renderModuleContent()æ›´æ–°è¡¨æ ¼
            } catch (error) {
                console.error("æ·»åŠ æ–‡æ¡£æ—¶å‡ºé”™: ", error);
                showMessage("æ·»åŠ å®éªŒæ•°æ®å¤±è´¥ã€‚", "error");
            }
        }

        // å¤„ç†æ™ºèƒ½è®¾è®¡ç”Ÿæˆ
        async function handleGenerateDesign() {
            isLoadingLLM = true;
            document.getElementById('llm-spinner').classList.remove('hidden');
            document.getElementById('generate-design-btn').disabled = true;
            
            const designForm = document.getElementById('design-modal').querySelector('.space-y-4');
            designParams.desiredMorphology = designForm.elements['desiredMorphology'].value;
            designParams.desiredCrystalStructure = designForm.elements['desiredCrystalStructure'].value;
            designParams.targetConversionRate = parseFloat(designForm.elements['targetConversionRate'].value) || 0;

            const prompt = `As an expert catalysis researcher specializing in formaldehyde oxidation using manganese oxides, suggest an experiment design in JSON format.
            The desired morphology is "${designParams.desiredMorphology}", crystal structure is "${designParams.desiredCrystalStructure}", and target formaldehyde conversion rate is ${designParams.targetConversionRate}%.
            Provide practical and realistic values for the following fields for MnO2 catalysts, ensuring numerical fields are actual numbers (not strings):
            "catalystMethod": (e.g., æ°´çƒ­æ³•, æ²‰æ·€æ³•, æº¶èƒ¶-å‡èƒ¶æ³•, æ¨¡æ¿æ³•),
            "morphology": (confirming desired, e.g., çº³ç±³çº¿, çº³ç±³æ£’, çº³ç±³é¢—ç²’),
            "crystalStructure": (confirming desired, e.g., Î±-MnOâ‚‚, Î²-MnOâ‚‚, Î³-MnOâ‚‚, Î´-MnOâ‚‚),
            "temperature": (degrees Celsius, integer),
            "gasFlow": (mL/min, integer),
            "hchoConcentration": (ppm, integer),
            "catalystAmount": (mg, integer),
            "conversionRate": (%, float, near target but realistic),
            "reactionTime": (min, integer),
            "notes": (brief rationale for the design).
            Ensure the output is a single JSON object.`;

            const chatHistory = [{ role: "user", parts: [{ text: prompt }] }];
            const payload = {
                contents: chatHistory,
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: {
                        type: "OBJECT",
                        properties: {
                            "catalystMethod": { "type": "STRING" },
                            "morphology": { "type": "STRING" },
                            "crystalStructure": { "type": "STRING" },
                            "temperature": { "type": "NUMBER" },
                            "gasFlow": { "type": "NUMBER" },
                            "hchoConcentration": { "type": "NUMBER" },
                            "catalystAmount": { "type": "NUMBER" },
                            "conversionRate": { "type": "NUMBER" },
                            "reactionTime": { "type": "NUMBER" },
                            "notes": { "type": "STRING" }
                        },
                        required: ["catalystMethod", "morphology", "crystalStructure", "temperature", "gasFlow", "hchoConcentration", "catalystAmount", "conversionRate", "reactionTime", "notes"]
                    }
                }
            };
            const apiKey = ""; // Canvasä¼šè‡ªåŠ¨æä¾›
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(`APIé”™è¯¯: ${response.status} ${response.statusText} - ${errorData.error.message}`);
                }

                const result = await response.json();
                
                if (result.candidates && result.candidates.length > 0 && result.candidates[0].content && result.candidates[0].content.parts && result.candidates[0].content.parts.length > 0) {
                    const jsonString = result.candidates[0].content.parts[0].text;
                    const generatedDesign = JSON.parse(jsonString);

                    // é¢„å¡«å……æ–°å®éªŒè¡¨å•
                    const addForm = document.getElementById('add-experiment-form');
                    addForm.elements['experimentId'].value = `Exp-${Date.now().toString().slice(-6)}`;
                    addForm.elements['catalystMethod'].value = generatedDesign.catalystMethod;
                    addForm.elements['morphology'].value = generatedDesign.morphology || designParams.desiredMorphology;
                    addForm.elements['crystalStructure'].value = generatedDesign.crystalStructure || designParams.desiredCrystalStructure;
                    addForm.elements['temperature'].value = generatedDesign.temperature;
                    addForm.elements['gasFlow'].value = generatedDesign.gasFlow;
                    addForm.elements['hchoConcentration'].value = generatedDesign.hchoConcentration;
                    addForm.elements['catalystAmount'].value = generatedDesign.catalystAmount;
                    addForm.elements['conversionRate'].value = generatedDesign.conversionRate;
                    addForm.elements['reactionTime'].value = generatedDesign.reactionTime;
                    addForm.elements['notes'].value = generatedDesign.notes;

                    showMessage("æ™ºèƒ½å®éªŒè®¾è®¡ç”ŸæˆæˆåŠŸï¼", "success");
                    isDesignModalOpen = false; // å…³é—­è®¾è®¡æ¨¡æ€æ¡†
                    isAddModalOpen = true;    // æ‰“å¼€æ·»åŠ å®éªŒæ¨¡æ€æ¡†
                    renderModals();
                } else {
                    throw new Error("LLMå“åº”æ ¼å¼æ— æ•ˆã€‚");
                }
            } catch (error) {
                console.error("ç”Ÿæˆå®éªŒè®¾è®¡æ—¶å‡ºé”™:", error);
                showMessage(`ç”Ÿæˆå®éªŒè®¾è®¡å¤±è´¥: ${error.message}`, "error");
            } finally {
                isLoadingLLM = false;
                document.getElementById('llm-spinner').classList.add('hidden');
                document.getElementById('generate-design-btn').disabled = false;
            }
        }

        // å¯¼å‡ºæ•°æ®åˆ°CSV
        function exportToCSV() {
            const currentFilteredExperiments = getFilteredExperiments();
            if (currentFilteredExperiments.length === 0) {
                showMessage("æ²¡æœ‰æ•°æ®å¯ä»¥å¯¼å‡ºã€‚", "error");
                return;
            }

            const headers = [
                "å®éªŒç¼–å·", "å‚¬åŒ–å‰‚åˆ¶å¤‡", "å½¢è²Œ", "æ™¶å‹", "æ¸©åº¦(Â°C)", "æ°”ä½“æµé€Ÿ(mL/min)",
                "ç”²é†›æµ“åº¦(ppm)", "å‚¬åŒ–å‰‚ç”¨é‡(mg)", "è½¬åŒ–ç‡(%)", "ååº”æ—¶é•¿(min)", "å¤‡æ³¨",
                "åˆ›å»ºè€…", "åˆ›å»ºæ—¶é—´"
            ];
            const rows = currentFilteredExperiments.map(exp => [
                `"${exp.experimentId || ''}"`,
                `"${exp.catalystMethod || ''}"`,
                `"${exp.morphology || ''}"`,
                `"${exp.crystalStructure || ''}"`,
                exp.temperature !== undefined ? exp.temperature : '',
                exp.gasFlow !== undefined ? exp.gasFlow : '',
                exp.hchoConcentration !== undefined ? exp.hchoConcentration : '',
                exp.catalystAmount !== undefined ? exp.catalystAmount : '',
                exp.conversionRate !== undefined ? exp.conversionRate : '',
                exp.reactionTime !== undefined ? exp.reactionTime : '',
                `"${(exp.notes || '').replace(/"/g, '""')}"`,
                `"${exp.createdBy || ''}"`,
                `"${exp.createdAt || ''}"`
            ]);

            let csvContent = headers.join(",") + "\n";
            rows.forEach(row => {
                csvContent += row.join(",") + "\n";
            });

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            if (link.download !== undefined) {
                const url = URL.createObjectURL(blob);
                link.setAttribute("href", url);
                link.setAttribute("download", "å®éªŒæ•°æ®.csv");
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                showMessage("æ•°æ®å·²æˆåŠŸå¯¼å‡ºä¸º CSVã€‚", "success");
            } else {
                showMessage("æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒç›´æ¥ä¸‹è½½æ–‡ä»¶ã€‚è¯·å°è¯•å¤åˆ¶å†…å®¹ã€‚", "error");
            }
        }

        // ä¸»æ¸²æŸ“å‡½æ•°ï¼Œæ ¹æ®activeTabæ¸²æŸ“å¯¹åº”æ¨¡å—å†…å®¹
        function renderModuleContent() {
            const moduleContentDiv = document.getElementById('module-content');
            moduleContentDiv.innerHTML = ''; // æ¸…ç©ºæ—§å†…å®¹
            
            // æ˜¾ç¤ºåŠ è½½æŒ‡ç¤ºå™¨ç›´åˆ°Firebaseè®¤è¯å°±ç»ª
            if (!isAuthReady) {
                document.getElementById('loading-indicator').classList.remove('hidden');
                return;
            } else {
                document.getElementById('loading-indicator').classList.add('hidden');
            }

            if (activeTab === 'literature') {
                moduleContentDiv.innerHTML = renderLiteratureSearch();
                attachLiteratureListeners();
            } else if (activeTab === 'data') {
                moduleContentDiv.innerHTML = renderDataManagement();
                attachDataManagementListeners();
                // ç¡®ä¿Firestoreç›‘å¬å™¨åœ¨æ¯æ¬¡æ¸²æŸ“æ•°æ®æ¨¡å—æ—¶éƒ½æœ‰æ•ˆ
                // (æ³¨æ„ï¼šonSnapshotä¼šåœ¨é¦–æ¬¡æ¸²æŸ“å’Œæ¯æ¬¡æ•°æ®å˜åŒ–æ—¶è§¦å‘ï¼Œæ‰€ä»¥éœ€è¦ç¡®ä¿å®ƒåªè¢«è®¾ç½®ä¸€æ¬¡æˆ–æ­£ç¡®ç®¡ç†)
                // æ­¤å¤„ç®€åŒ–å¤„ç†ï¼Œæ¯æ¬¡æ¸²æŸ“éƒ½å°è¯•è®¾ç½®ï¼ŒFirestoreå†…éƒ¨ä¼šå¤„ç†é‡å¤ç›‘å¬ã€‚
                if (db) {
                    const experimentsCollection = collection(db, `artifacts/${appId}/public/data/experiments`);
                    const q = query(experimentsCollection);
                    onSnapshot(q, (querySnapshot) => {
                        const experimentsData = [];
                        querySnapshot.forEach((doc) => {
                            experimentsData.push({ id: doc.id, ...doc.data() });
                        });
                        experimentsData.sort((a, b) => (b.experimentId || '').localeCompare(a.experimentId || ''));
                        experiments = experimentsData; // æ›´æ–°å…¨å±€experimentsæ•°æ®
                        renderModuleContent(); // é‡æ–°æ¸²æŸ“æ•°æ®è§†å›¾ä»¥åæ˜ æœ€æ–°æ•°æ®
                    }, (error) => {
                        console.error("è·å–å®éªŒæ•°æ®æ—¶å‡ºé”™: ", error);
                        showMessage("åŠ è½½å®éªŒæ•°æ®å¤±è´¥ã€‚", "error");
                    });
                }
            }
            renderModals(); // ç¡®ä¿æ¨¡æ€æ¡†çŠ¶æ€æ­£ç¡®
        }

        // é¡µé¢åŠ è½½å®Œæˆæ—¶æ‰§è¡Œ
        document.addEventListener('DOMContentLoaded', () => {
            initializeFirebase(); // åˆå§‹åŒ–Firebase

            // ç»‘å®šé¡¶éƒ¨TabæŒ‰é’®äº‹ä»¶
            document.querySelectorAll('.tab-button').forEach(button => {
                button.addEventListener('click', (e) => {
                    document.querySelectorAll('.tab-button').forEach(btn => {
                        btn.classList.remove('bg-white', 'text-blue-600', 'border-b-2', 'border-blue-600');
                        btn.classList.add('text-gray-500', 'hover:text-blue-600');
                    });
                    e.target.classList.remove('text-gray-500', 'hover:text-blue-600');
                    e.target.classList.add('bg-white', 'text-blue-600', 'border-b-2', 'border-blue-600');
                    activeTab = e.target.dataset.tab;
                    renderModuleContent(); // åˆ‡æ¢Tabæ—¶é‡æ–°æ¸²æŸ“å†…å®¹
                });
            });

            // æ¨¡æ€æ¡†çš„å…³é—­/å–æ¶ˆæŒ‰é’®äº‹ä»¶
            document.getElementById('close-add-modal').addEventListener('click', () => {
                isAddModalOpen = false;
                renderModals();
            });
            document.getElementById('cancel-add-modal').addEventListener('click', () => {
                isAddModalOpen = false;
                renderModals();
            });
            document.getElementById('add-experiment-form').addEventListener('submit', handleAddExperimentSubmit);

            document.getElementById('close-design-modal').addEventListener('click', () => {
                isDesignModalOpen = false;
                renderModals();
            });
            document.getElementById('cancel-design-modal').addEventListener('click', () => {
                isDesignModalOpen = false;
                renderModals();
            });
            document.getElementById('generate-design-btn').addEventListener('click', handleGenerateDesign);
        });
    </script>
</body>
</html>